define(["exports","./vendor-22992e2c","./visibility-c7f197c2","./base-fbc1ccef","./useTranslations-561064a5","./useGraphClient-6c0c047b","./useLocalStorage-9756f032","./useSpacesLoading-b404aeae","./AppLoadingSpinner-348c6387","./functions-f74c7f04","./useUserContext-a419a918"],(function(e,t,r,s,a,i,o,n,c,l,u){"use strict";const d=t.defineComponent({name:"AccessDeniedPage",setup(){const e=r.useStore(),{$gettext:s}=a.useTranslations();return{logoImg:t.computed((()=>e.getters.configuration.currentTheme.logo.login)),cardTitle:t.computed((()=>s("Logged out"))),cardHint:t.computed((()=>s("You were automatically logged out for security reasons."))),footerSlogan:t.computed((()=>e.getters.configuration.currentTheme.general.slogan)),navigateToLoginText:t.computed((()=>s("Log in again")))}}});var h=function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",{staticClass:"oc-height-viewport oc-flex oc-flex-column oc-flex-center oc-flex-middle"},[r("div",{staticClass:"oc-login-card"},[r("img",{staticClass:"oc-login-logo",attrs:{src:e.logoImg,alt:"","aria-hidden":!0}}),e._v(" "),r("div",{staticClass:"oc-login-card-body oc-width-medium"},[r("h2",{staticClass:"oc-login-card-title",domProps:{textContent:e._s(e.cardTitle)}}),e._v(" "),r("p",{domProps:{textContent:e._s(e.cardHint)}})]),e._v(" "),r("div",{staticClass:"oc-login-card-footer oc-pt-rm"},[r("p",[e._v("\n        "+e._s(e.footerSlogan)+"\n      ")])])]),e._v(" "),r("oc-button",{staticClass:"oc-mt-m oc-width-medium",attrs:{id:"exitAnchor",type:"router-link",to:{name:"login"},size:"large",appearance:"filled",variation:"primary"},domProps:{textContent:e._s(e.navigateToLoginText)}})],1)};h._withStripped=!0;const m=t.normalizeComponent({render:h,staticRenderFns:[]},undefined,d,undefined,false,undefined,!1,void 0,void 0,void 0);const p={name:"EditPasswordModal",data:function(){return{currentPassword:"",newPassword:"",newPasswordConfirm:"",passwordConfirmErrorMessage:""}},computed:{confirmButtonDisabled:function(){return!this.currentPassword.trim().length||!this.newPassword.trim().length||this.newPassword!==this.newPasswordConfirm}},methods:{editPassword:function(){this.$emit("confirm",this.currentPassword,this.newPassword)},validatePasswordConfirm:function(){return this.passwordConfirmErrorMessage="",!this.newPassword.trim().length||!this.newPasswordConfirm.trim().length||this.newPassword===this.newPasswordConfirm||(this.passwordConfirmErrorMessage=this.$gettext("Password and password confirmation must be identical"),!1)}}};var g=function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("oc-modal",{attrs:{title:e.$gettext("Change password"),"button-cancel-text":e.$gettext("Cancel"),"button-confirm-text":e.$gettext("Confirm"),"button-confirm-disabled":e.confirmButtonDisabled},on:{confirm:e.editPassword,cancel:function(t){return e.$emit("cancel")}},scopedSlots:e._u([{key:"content",fn:function(){return[r("oc-text-input",{attrs:{label:e.$gettext("Current password"),type:"password","fix-message-line":!0},model:{value:e.currentPassword,callback:function(t){e.currentPassword=t},expression:"currentPassword"}}),e._v(" "),r("oc-text-input",{attrs:{label:e.$gettext("New password"),type:"password","fix-message-line":!0},on:{change:e.validatePasswordConfirm},model:{value:e.newPassword,callback:function(t){e.newPassword=t},expression:"newPassword"}}),e._v(" "),r("oc-text-input",{attrs:{label:e.$gettext("Repeat new password"),type:"password","fix-message-line":!0,"error-message":e.passwordConfirmErrorMessage},on:{change:e.validatePasswordConfirm},model:{value:e.newPasswordConfirm,callback:function(t){e.newPasswordConfirm=t},expression:"newPasswordConfirm"}})]},proxy:!0}])})};g._withStripped=!0;const f=t.normalizeComponent({render:g,staticRenderFns:[]},undefined,p,undefined,false,undefined,!1,void 0,void 0,void 0);const v=t.defineComponent({name:"Personal",components:{EditPasswordModal:f},setup:()=>({...i.useGraphClient()}),data:()=>({editPasswordModalOpen:!1}),computed:{...t.mapGetters(["user","getNavItemsByExtension","apps","capabilities"]),isAccountEditingEnabled(){return!this.apps.settings},isChangePasswordEnabled(){return this.capabilities.spaces?.enabled},pageTitle(){return this.$gettext(this.$route.meta.title)},editUrl(){return this.isAccountEditingEnabled?s.urlJoin(r.configurationManager.serverUrl,"/index.php/settings/personal"):null},editRoute(){const e=this.getNavItemsByExtension("settings");return e.length>0?e[0].route||{}:null},groupNames(){return this.capabilities.spaces?.enabled?this.user.groups.map((e=>e.displayName)).join(", "):this.user.groups.join(", ")}},methods:{...t.mapActions(["showMessage"]),showEditPasswordModal(){this.editPasswordModalOpen=!0},closeEditPasswordModal(){this.editPasswordModalOpen=!1},editPassword(e,t){return this.graphClient.users.changeOwnPassword(e.trim(),t.trim()).then((()=>{this.closeEditPasswordModal(),this.showMessage({title:this.$gettext("Password was changed successfully")})})).catch((e=>{console.error(e),this.showMessage({title:this.$gettext("Failed to change password"),status:"danger"})}))}}});var w=function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("main",{staticClass:"oc-height-1-1 oc-m",attrs:{id:"account"}},[r("div",{staticClass:"oc-flex oc-flex-between oc-flex-bottom oc-width-1-1 oc-border-b oc-py"},[r("h1",{staticClass:"oc-page-title oc-m-rm",attrs:{id:"account-page-title"}},[e._v(e._s(e.pageTitle))]),e._v(" "),r("div",[e.editPasswordModalOpen?r("edit-password-modal",{on:{cancel:e.closeEditPasswordModal,confirm:e.editPassword}}):e._e(),e._v(" "),e.isChangePasswordEnabled?r("oc-button",{attrs:{variation:"primary","data-testid":"account-page-edit-url-btn"},on:{click:e.showEditPasswordModal}},[r("oc-icon",{attrs:{name:"lock"}}),e._v(" "),r("translate",[e._v("Change Password")])],1):e._e(),e._v(" "),e.editUrl?r("oc-button",{attrs:{variation:"primary",type:"a",href:e.editUrl,"data-testid":"account-page-edit-url-btn"}},[r("oc-icon",{attrs:{name:"edit"}}),e._v(" "),r("translate",[e._v("Edit")])],1):e.editRoute?r("oc-button",{attrs:{variation:"primary",type:"router-link",to:e.editRoute,"data-testid":"account-page-edit-route-btn"}},[r("oc-icon",{attrs:{name:"edit"}}),e._v(" "),r("translate",[e._v("Edit")])],1):e._e()],1)]),e._v(" "),r("h2",{directives:[{name:"translate",rawName:"v-translate"}],staticClass:"oc-text-bold oc-mb"},[e._v("Account Information")]),e._v(" "),r("dl",{staticClass:"account-page-info oc-flex oc-flex-wrap"},[r("div",{staticClass:"account-page-info-username oc-mb oc-width-1-2@s"},[r("dt",{directives:[{name:"translate",rawName:"v-translate"}],staticClass:"oc-text-normal oc-text-muted"},[e._v("Username")]),e._v(" "),r("dd",[e._v("\n        "+e._s(e.user.username||e.user.id)+"\n      ")])]),e._v(" "),e.user.username&&e.user.id?r("div",{staticClass:"account-page-info-userid"},[r("dt",{directives:[{name:"translate",rawName:"v-translate"}],staticClass:"oc-text-normal oc-text-muted"},[e._v("User ID")]),e._v(" "),r("dd",[e._v("\n        "+e._s(e.user.id)+"\n      ")])]):e._e(),e._v(" "),r("div",{staticClass:"account-page-info-displayname oc-mb oc-width-1-2@s"},[r("dt",{directives:[{name:"translate",rawName:"v-translate"}],staticClass:"oc-text-normal oc-text-muted"},[e._v("Display name")]),e._v(" "),r("dd",[e._v("\n        "+e._s(e.user.displayname)+"\n      ")])]),e._v(" "),r("div",{staticClass:"account-page-info-email oc-mb oc-width-1-2@s"},[r("dt",{directives:[{name:"translate",rawName:"v-translate"}],staticClass:"oc-text-normal oc-text-muted"},[e._v("Email")]),e._v(" "),r("dd",[e.user.email?[e._v(e._s(e.user.email))]:r("span",{directives:[{name:"translate",rawName:"v-translate"}]},[e._v("No email has been set up")])],2)]),e._v(" "),r("div",{staticClass:"account-page-info-groups oc-mb oc-width-1-2@s"},[r("dt",{directives:[{name:"translate",rawName:"v-translate"}],staticClass:"oc-text-normal oc-text-muted"},[e._v("Group memberships")]),e._v(" "),r("dd",{attrs:{"data-testid":"group-names"}},[e.groupNames?r("span",[e._v(e._s(e.groupNames))]):r("span",{directives:[{name:"translate",rawName:"v-translate"}],attrs:{"data-testid":"group-names-empty"}},[e._v("You are not part of any group")])])])])])};w._withStripped=!0;const C=t.normalizeComponent({render:w,staticRenderFns:[]},undefined,v,undefined,false,undefined,!1,void 0,void 0,void 0);const b=t.defineComponent({name:"LoginPage",components:{AppLoadingSpinner:c.__vue_component__},setup(){const e=r.useStore(),s=n.useRouteQuery("redirectUrl"),a=()=>{G.loginUser(n.queryItemAsString(t.unref(s)))},i=t.computed((()=>e.getters.configuration.currentTheme.loginPage.autoRedirect));t.unref(i)&&a();return{autoRedirect:i,productName:t.computed((()=>e.getters.configuration.currentTheme.general.name)),logoImg:t.computed((()=>e.getters.configuration.currentTheme.logo.login)),footerSlogan:t.computed((()=>e.getters.configuration.currentTheme.general.slogan)),performLogin:a}}});var _=function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",{staticClass:"oc-width-1-1 oc-height-1-1"},[e.autoRedirect?r("app-loading-spinner"):r("div",{staticClass:"oc-height-viewport oc-flex oc-flex-column oc-flex-center oc-flex-middle"},[r("div",{staticClass:"oc-login-card"},[r("img",{staticClass:"oc-login-logo",attrs:{src:e.logoImg,alt:"","aria-hidden":!0}}),e._v(" "),r("div",{staticClass:"oc-login-card-body oc-width-medium"},[r("h2",{staticClass:"oc-login-card-title"},[r("translate",{attrs:{"translate-params":{productName:e.productName}}},[e._v("Welcome to %{productName}")])],1),e._v(" "),r("p",{directives:[{name:"translate",rawName:"v-translate"}]},[e._v("\n          Please click the button below to authenticate and get access to your data.\n        ")])]),e._v(" "),r("div",{staticClass:"oc-login-card-footer oc-pt-rm"},[r("p",[e._v(e._s(e.footerSlogan))])])]),e._v(" "),r("oc-button",{staticClass:"oc-mt-m oc-width-medium oc-login-authorize-button",attrs:{id:"authenticate",size:"large",variation:"primary",appearance:"filled"},on:{click:e.performLogin}},[r("translate",[e._v("Login")])],1)],1)],1)};_._withStripped=!0;const y=t.normalizeComponent({render:_,staticRenderFns:[]},undefined,b,undefined,false,undefined,!1,void 0,void 0,void 0);const S=t.defineComponent({name:"LogoutPage",setup(){const e=n.useRouter(),s=r.useStore(),{$gettext:i}=a.useTranslations();G.logoutUser().then((()=>{e.push({name:"login"})}));return{logoImg:t.computed((()=>s.getters.configuration.currentTheme.logo.login)),cardTitle:t.computed((()=>i("Logout in progress"))),cardHint:t.computed((()=>i("Please wait while you're being logged out."))),footerSlogan:t.computed((()=>s.getters.configuration.currentTheme.general.slogan))}}});var x=function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",{staticClass:"oc-login-card oc-position-center"},[r("img",{staticClass:"oc-login-logo",attrs:{src:e.logoImg,alt:"","aria-hidden":!0}}),e._v(" "),r("div",{staticClass:"oc-login-card-body oc-width-medium"},[r("h2",{staticClass:"oc-login-card-title",domProps:{textContent:e._s(e.cardTitle)}}),e._v(" "),r("p",{domProps:{textContent:e._s(e.cardHint)}})]),e._v(" "),r("div",{staticClass:"oc-login-card-footer oc-pt-rm"},[r("p",[e._v("\n      "+e._s(e.footerSlogan)+"\n    ")])])])};x._withStripped=!0;const P=t.normalizeComponent({render:x,staticRenderFns:[]},undefined,S,undefined,false,undefined,!1,void 0,void 0,void 0);const k=t.defineComponent({name:"OidcCallbackPage",setup(){const e=r.useStore(),s=t.ref(!1),a=t.computed((()=>e.getters.configuration.currentTheme.logo.login)),i=t.computed((()=>e.getters.configuration.currentTheme.general.slogan)),o=n.useRoute();return t.onMounted((()=>{if(t.unref(o).query.error)return s.value=!0,void console.warn(`OAuth error: ${t.unref(o).query.error} - ${t.unref(o).query.error_description}`);"/oidc-silent-redirect"===t.unref(o).path?G.signInSilentCallback():G.signInCallback()})),{error:s,logoImg:a,footerSlogan:i}}});var R=function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",{staticClass:"oc-login-card oc-position-center"},[r("img",{staticClass:"oc-login-logo",attrs:{src:e.logoImg,alt:"","aria-hidden":!0}}),e._v(" "),r("div",{directives:[{name:"show",rawName:"v-show",value:e.error,expression:"error"}],staticClass:"oc-login-card-body"},[r("h2",{directives:[{name:"translate",rawName:"v-translate"}],staticClass:"oc-login-card-title"},[e._v("Authentication failed")]),e._v(" "),r("p",{directives:[{name:"translate",rawName:"v-translate"}]},[e._v("Please contact the administrator if this error persists.")])]),e._v(" "),r("div",{directives:[{name:"show",rawName:"v-show",value:!e.error,expression:"!error"}],staticClass:"oc-login-card-body"},[r("h3",{directives:[{name:"translate",rawName:"v-translate"}],staticClass:"oc-login-card-title"},[e._v("Logging you in")]),e._v(" "),r("p",{directives:[{name:"translate",rawName:"v-translate"}]},[e._v("Please wait, you are being redirected.")])]),e._v(" "),r("div",{staticClass:"oc-login-card-footer oc-pt-rm"},[r("p",[e._v(e._s(e.footerSlogan))])])])};R._withStripped=!0;const E=t.normalizeComponent({render:R,staticRenderFns:[]},undefined,k,undefined,false,undefined,!1,void 0,void 0,void 0);const M=t.defineComponent({name:"ResolvePublicLink",setup(){const e=i.useClientService(),o=n.useRouter(),c=r.useStore(),d=n.useRouteParam("token"),h=n.useRouteQuery("redirectUrl"),m=t.ref(""),p=t.computed((()=>l.buildPublicSpaceResource({id:t.unref(d),driveAlias:`public/${t.unref(d)}`,driveType:"public",webDavPath:l.buildWebDavPublicPath(t.unref(d),""),...t.unref(m)&&{publicLinkPassword:t.unref(m)}}))),g=u.useUserContext({store:c}),{loadTokenInfoTask:f}=function(e){const{owncloudSdk:s}=e.clientService||i.useClientService(),a=e.isUserContext||u.useUserContext({store:r.useStore()});return{loadTokenInfoTask:t.C((function*(e,r){let i;try{i=t.unref(a)?yield s.shares.getProtectedTokenInfo(r):yield s.shares.getUnprotectedTokenInfo(r)}catch(e){return{}}return{...i,alias_link:"true"===i.alias_link,password_protected:"true"===i.password_protected}}))}}({clientService:e,isUserContext:g}),v=t.ref(null),w=t.ref(),C=t.C((function*(){if(!t.isEmpty(t.unref(v)))return t.unref(v).password_protected;try{let r={...t.unref(p),publicLinkPassword:null};return yield e.webdav.getFileInfo(r),!1}catch(e){if(401===e.statusCode)return!0;throw e}})),b=t.C((function*(){const r=yield e.webdav.getFileInfo(t.unref(p));if(!l.isPublicSpaceResource(r)){const e=new Error("resolved resource has wrong type");throw e.resource=r,e}return r})),_=t.computed((()=>!!b.isError&&401===b.last.error.statusCode)),y=t.C((function*(e,r){if(!t.isEmpty(t.unref(v))&&t.unref(v)?.alias_link)return a=t.unref(v).id,void o.push({name:"resolvePrivateLink",params:{fileId:`${a}`}});var a;const i=yield b.perform();if(b.isError){const e=b.last.error;return void console.error(e,e.resource)}yield G.resolvePublicLink(t.unref(d),t.unref(r),t.unref(r)?t.unref(m):"");const c=n.queryItemAsString(t.unref(h));c?o.push({path:c}):i.publicLinkPermission!==s.SharePermissionBit.Create?o.push({name:"files-public-link",params:{driveAliasAndItem:`public/${t.unref(d)}`}}):o.push({name:"files-public-upload",params:{token:t.unref(d)}})})),S=t.computed((()=>!(!f.isRunning&&f.last&&!C.isRunning&&C.last)||!t.unref(w)&&(y.isRunning||!y.last))),x=t.computed((()=>f.isError?f.last.error:C.isError?C.last.error:null));t.onMounted((async()=>{v.value=await f.perform(t.unref(d)),w.value=await C.perform(),t.unref(w)||await y.perform(!1)}));const{$gettext:P}=a.useTranslations(),k=t.computed((()=>c.getters.configuration.currentTheme.general.slogan)),R=t.computed((()=>P("Enter password for public link"))),E=t.computed((()=>t.unref(_)?P("Incorrect password"):null));return{token:d,isPasswordRequired:w,password:m,wrongPassword:_,passwordFieldLabel:R,wrongPasswordMessage:E,isLoading:S,errorMessage:x,footerSlogan:k,resolvePublicLinkTask:y}}});var T=function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",{staticClass:"oc-link-resolve oc-height-viewport oc-flex oc-flex-column oc-flex-center oc-flex-middle"},[r("div",{staticClass:"oc-card oc-text-center oc-width-large"},[e.isLoading?[r("div",{staticClass:"oc-card-header"},[r("h2",{key:"public-link-loading"},[r("translate",[e._v("Loading public link…")])],1)]),e._v(" "),r("div",{staticClass:"oc-card-body"},[r("oc-spinner",{attrs:{"aria-hidden":!0}})],1)]:e.errorMessage?[r("div",{staticClass:"oc-card-header oc-link-resolve-error-title"},[r("h2",{key:"public-link-error"},[r("translate",[e._v("An error occurred while loading the public link")])],1)]),e._v(" "),r("div",{staticClass:"oc-card-body oc-link-resolve-error-message"},[r("p",{staticClass:"oc-text-xlarge"},[e._v(e._s(e.errorMessage))])])]:e.isPasswordRequired?[r("form",{on:{submit:function(t){return t.preventDefault(),e.resolvePublicLinkTask.perform(!0)}}},[r("div",{staticClass:"oc-card-header"},[r("h2",[r("translate",[e._v("This resource is password-protected")])],1)]),e._v(" "),r("div",{staticClass:"oc-card-body"},[r("oc-text-input",{ref:"passwordInput",staticClass:"oc-mb-s",attrs:{"error-message":e.wrongPasswordMessage,label:e.passwordFieldLabel,type:"password"},model:{value:e.password,callback:function(t){e.password=t},expression:"password"}}),e._v(" "),r("oc-button",{staticClass:"oc-login-authorize-button",attrs:{variation:"primary",appearance:"filled",disabled:!e.password,submit:"submit"}},[r("translate",[e._v("Continue")])],1)],1)])]:e._e(),e._v(" "),r("div",{staticClass:"oc-card-footer oc-pt-rm"},[r("p",[e._v(e._s(e.footerSlogan))])])],2)])};T._withStripped=!0;const I=t.normalizeComponent({render:T,staticRenderFns:[]},undefined,M,undefined,false,undefined,!1,void 0,void 0,void 0);const L=t.defineComponent({name:"ResolvePrivateLink",setup(){const e=r.useStore(),o=n.useRouter(),c=n.useRouteParam("fileId"),{$gettext:u,$gettextInterpolate:d}=a.useTranslations(),h=n.useCapabilitySpacesEnabled(e),m=t.ref(),p=t.ref(),g=t.ref(!1),f=i.useClientService();t.onMounted((()=>{w.perform(n.queryItemAsString(t.unref(c)))}));const{loadFileInfoByIdTask:v}=(e=>{const{webdav:r}=e.clientService||i.useClientService(),a=e.davProperties||[s.DavProperty.FileId,s.DavProperty.FileParent,s.DavProperty.Name,s.DavProperty.ResourceType];return{loadFileInfoByIdTask:t.C((function*(e,t){const s=l.buildSpace({id:t,webDavPath:l.buildWebDavSpacesPath(t)});return yield r.getFileInfo(s,{},{davProperties:a})}))}})({clientService:f}),w=t.C((function*(e,a){let i,c,u,d=C(a);if(d)i=yield f.owncloudSdk.files.getPathForFileId(a),m.value=yield f.webdav.getFileInfo(d,{path:i});else{let e=b(a);m.value=yield v.perform(a);const o=e?[]:[t.unref(m).name];let n=t.unref(m);for(;!e;){try{n=yield v.perform(n.parentFolderId)}catch(e){throw g.value=!0,Error(e)}p.value=n,e=b(n.id),e||o.unshift(n.name)}d=l.buildShareSpaceResource({shareId:e.nodeId,shareName:e.name,serverUrl:r.configurationManager.serverUrl}),i=s.urlJoin(...o)}"folder"===t.unref(m).type?c=t.unref(m).fileId:(c=t.unref(m).parentFolderId,u=t.unref(m).name,i=t.dirname(i));const{params:h,query:w}=n.createFileRouteOptions(d,{fileId:c,path:i}),_={name:"files-spaces-generic",params:h,query:{...w,...u&&{scrollTo:u}}};o.push(_)})),C=r=>t.unref(h)?e.getters["runtime/spaces/spaces"].find((e=>r.startsWith(e.id))):e.getters["runtime/spaces/spaces"].find((e=>l.isPersonalSpaceResource(e))),b=t=>e.getters["runtime/spaces/spaces"].find((e=>l.isMountPointSpaceResource(e)&&e.root?.remoteItem?.id===t)),_=t.computed((()=>!w.last||w.isRunning)),y=t.computed((()=>({name:"files-shares-with-me"}))),S=t.computed((()=>u('Open "Shared with me"')));return{errorMessage:t.computed((()=>{if(t.unref(g)){if(!t.unref(p)||t.unref(m).name===t.unref(p).name)return"file"===t.unref(m).type?u('This file has been shared with you. Accept it in "Shares" > "Shared with me" to view it.'):u('This folder has been shared with you. Accept it in "Shares" > "Shared with me" to view it.');let e;return e="file"===t.unref(m).type?u('This file has been shared with you via "%{parentShareName}". Accept the share "%{parentShareName}" in "Shares" > "Shared with me" to view it.'):u('This folder has been shared with you via "%{parentShareName}". Accept the share "%{parentShareName}" in "Shares" > "Shared with me" to view it.'),d(e,{parentShareName:t.unref(p).name})}return w.isError?w.last.error:null})),loading:_,resource:m,isUnacceptedShareError:g,sharedWithMeRoute:y,openSharedWithMeLabel:S}}});var U=function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",{staticClass:"oc-link-resolve oc-height-viewport oc-flex oc-flex-column oc-flex-center oc-flex-middle"},[r("div",{staticClass:"oc-card oc-text-center oc-width-large"},[e.loading?[r("div",{staticClass:"oc-card-header"},[r("h2",{key:"private-link-loading"},[r("translate",[e._v("Resolving private link…")])],1)]),e._v(" "),r("div",{staticClass:"oc-card-body"},[r("oc-spinner",{attrs:{"aria-hidden":!0}})],1)]:e.errorMessage?[r("div",{staticClass:"oc-card-header oc-link-resolve-error-title"},[e.isUnacceptedShareError?r("h2",[e._v("\n          "+e._s(e.resource.name)+"\n        ")]):r("h2",{key:"private-link-error"},[r("translate",[e._v("An error occurred while resolving the private link")])],1)]),e._v(" "),r("div",{staticClass:"oc-card-body oc-link-resolve-error-message"},[r("p",{staticClass:"oc-text-xlarge"},[e._v(e._s(e.errorMessage))]),e._v(" "),e.isUnacceptedShareError?r("p",{domProps:{textContent:e._s(e.$gettext("Note: You can reload this page after you accept the share."))}}):e._e()])]:e._e()],2),e._v(" "),e.isUnacceptedShareError?r("oc-button",{staticClass:"oc-mt-m oc-text-center oc-width-medium",attrs:{type:"router-link",variation:"primary",appearance:"filled",target:"_blank",to:e.sharedWithMeRoute}},[r("span",{staticClass:"text",domProps:{textContent:e._s(e.openSharedWithMeLabel)}})]):e._e()],1)};U._withStripped=!0;const A=t.normalizeComponent({render:U,staticRenderFns:[]},undefined,L,undefined,false,undefined,!1,void 0,void 0,void 0),N=(e,t)=>!(!e.query[n.contextRouteNameKey]&&!t.query[n.contextRouteNameKey])&&n.queryItemAsString(e.query[n.contextRouteNameKey])!==n.queryItemAsString(t.query[n.contextRouteNameKey]),$=e=>{const t=!!K,r=new URL(window.location.href.split("#")[0]);return r.search="",t?r.pathname=new URL(K.href).pathname:r.pathname.endsWith("/index.html")&&(r.pathname=r.pathname.split("/").slice(0,-1).filter(Boolean).join("/")),/\.(html?)$/i.test(e)?r.pathname=[...r.pathname.split("/"),...e.split("/")].filter(Boolean).join("/"):r[t?"pathname":"hash"]=W.resolve(e).href,r.href},q=(e,t)=>{const r=B(t);if("user"===r.authContext)return!0;if("hybrid"!==r.authContext)return!1;const s=z(e,t);return!s||"user"===B({meta:s.meta}).authContext},O=(e,t)=>{if(t.params.driveAliasAndItem?.startsWith("public/"))return!0;const r=B(t);if("publicLink"===r.authContext)return!0;if("hybrid"!==r.authContext)return!1;const s=z(e,t);return s&&"publicLink"===B({meta:s.meta}).authContext},F=e=>{const t=n.contextQueryToFileContextProps(e.query)?.routeParams;return D(t||e.params)},D=e=>Object.prototype.hasOwnProperty.call(e,"driveAliasAndItem")?e.driveAliasAndItem.startsWith("public/")?e.driveAliasAndItem.split("/")[1]:"":(e.item||e.filePath||e.token||"").split("/")[0],z=(e,t)=>t.query&&t.query.contextRouteName?e.getRoutes().find((e=>e.name===t.query.contextRouteName)):null,B=e=>{if(!e.meta)return{authContext:"user"};if(!e.meta.authContext&&Object.prototype.hasOwnProperty.call(e.meta,"auth")&&(e.meta.authContext=e.meta.auth?"user":"hybrid",console.warn(`route key meta.auth is deprecated. Please switch to meta.authContext="${e.meta.authContext}" in route "${e.name}".`)),e?.meta?.authContext){if(o.authContextValues.includes(e.meta.authContext))return e.meta;console.warn(`invalid authContext "${e.meta.authContext}" in route "${e.name}". must be one of [${o.authContextValues.join(", ")}].`)}return e?.meta?{...e.meta,authContext:"user"}:{authContext:"user"}};const K=document.querySelector("base"),W=(e=>{const r=e.match.bind(e),s=e=>[["%2F","/"],["//","/"]].reduce(((e,t)=>e.replaceAll(t[0],t[1])),e||"");return e.match=(e,a,i)=>{const o=r(e,a,i);return t.get(o,"meta.patchCleanPath",!1)?{...o,path:s(o.path),fullPath:s(o.fullPath)}:o},e})(new t.VueRouter$1({parseQuery:e=>t.lib.parse(e,{allowDots:!0}),stringifyQuery:e=>t.lib.stringify(e,{allowDots:!0,addQueryPrefix:!0}),...K&&{mode:"history",base:new URL(K.href).pathname},routes:[{path:"/login",name:"login",component:y,meta:{title:"Login",authContext:"anonymous"}},{path:"/logout",name:"logout",component:P,meta:{title:"Logout",authContext:"anonymous"}},{path:"/oidc-callback",name:"oidcCallback",component:E,meta:{title:"Oidc callback",authContext:"anonymous"}},{path:"/oidc-silent-redirect",name:"oidcSilentRedirect",component:E,meta:{title:"Oidc redirect",authContext:"anonymous"}},{path:"/f/:fileId",name:"resolvePrivateLink",component:A,meta:{title:"Private link",authContext:"user"}},{path:"/s/:token",name:"resolvePublicLink",component:I,meta:{title:"Public link",authContext:"anonymous"}},{path:"/access-denied",name:"accessDenied",component:m,meta:{title:"Access denied",authContext:"anonymous"}},{path:"/account",name:"account",component:C,meta:{title:"Account",authContext:"user"}}]}));(e=>{e.beforeEach((async(r,s,a)=>{if(s&&r.path===s.path&&!N(r,s))return a();const i=t.Vue.$store,o=t.Vue.$authService;if(await o.initializeContext(r),O(e,r)){if(!i.getters["runtime/auth/isPublicLinkContextReady"]){return a({name:"resolvePublicLink",params:{token:F(r)},query:{redirectUrl:r.fullPath}})}return a()}return q(e,r)?i.getters["runtime/auth/isUserContextReady"]?a():a({path:"/login",query:{redirectUrl:r.fullPath}}):a()}))})(W);const j="oc.postLoginRedirectUrl";class V extends t.oidcClientTs.UserManager{storePrefix;clientService;configurationManager;store;updateAccessTokenPromise;_unloadReason;constructor(e){const r="oc_oAuth.",s={userStore:new t.oidcClientTs.WebStorageStateStore({prefix:r,store:sessionStorage}),redirect_uri:$("/oidc-callback.html"),silent_redirect_uri:$("/oidc-silent-redirect.html"),response_mode:"query",response_type:"code",post_logout_redirect_uri:$("/"),accessTokenExpiringNotificationTimeInSeconds:10,authority:"",client_id:""};if(e.configurationManager.isOIDC)Object.assign(s,{scope:"openid profile",loadUserInfo:!0,...e.configurationManager.oidc});else if(e.configurationManager.isOAuth2){const t=e.configurationManager.oAuth2;Object.assign(s,{authority:t.url,client_id:t.clientId,...t.clientSecret&&{client_authentication:"client_secret_basic",client_secret:t.clientSecret},scope:"profile",loadUserInfo:!1,metadata:{issuer:t.url,authorization_endpoint:t.authUrl,token_endpoint:t.url,userinfo_endpoint:""}})}t.oidcClientTs.Log.setLogger(console),t.oidcClientTs.Log.setLevel(t.oidcClientTs.Log.INFO),super(s),this.storePrefix=r,this.clientService=e.clientService,this.configurationManager=e.configurationManager,this.store=e.store}async getAccessToken(){return(await this.getUser())?.access_token}async removeUser(e="logout"){this._unloadReason=e,await super.removeUser()}get unloadReason(){return this._unloadReason}getAndClearPostLoginRedirectUrl(){const e=sessionStorage.getItem(j)||"/";return sessionStorage.removeItem(j),e}setPostLoginRedirectUrl(e){e?sessionStorage.setItem(j,e):sessionStorage.removeItem(j)}updateContext(e){const t=!!this.store.getters.user.id;return this.store.getters["runtime/auth/accessToken"]!==e?(this.store.commit("runtime/auth/SET_ACCESS_TOKEN",e),this.updateAccessTokenPromise=(async()=>{this.initializeOwnCloudSdk(e),t||(await this.fetchUserInfo(e),this.store.commit("runtime/auth/SET_USER_CONTEXT_READY",!0))})(),this.updateAccessTokenPromise):this.updateAccessTokenPromise}initializeOwnCloudSdk(e){const t={baseUrl:this.configurationManager.serverUrl,auth:{bearer:e}};this.store.getters.user.id&&(t.userInfo={id:this.store.getters.user.id,"display-name":this.store.getters.user.displayname,email:this.store.getters.user.email}),this.clientService.owncloudSdk.init(t)}async fetchUserInfo(e){const t=await this.clientService.owncloudSdk.getCurrentUser();let r,s,a;await this.fetchCapabilities({accessToken:e});const i=await this.clientService.owncloudSdk.users.getUser(t.id);if(this.store.getters.capabilities.spaces?.enabled){const t=this.clientService.graphAuthenticated(this.configurationManager.serverUrl,e);s=await t.users.getMe();const[a,i]=await Promise.all([this.fetchRoles({accessToken:e}),this.fetchSettings()]);this.store.commit("SET_ROLES",a),this.store.commit("SET_SETTINGS_VALUES",i),r=await this.fetchRole({graphUser:s,accessToken:e,roles:a})}else a=await this.clientService.owncloudSdk.users.getUserGroups(t.id);this.store.commit("SET_USER",{id:t.id,uuid:s?.data?.id||"",username:t.username||t.id,displayname:i.displayname||t["display-name"],email:t?.email||i?.email||"",groups:s?.data?.memberOf||a||[],role:r,language:t?.language}),!this.store.getters.capabilities.spaces?.enabled&&i.quota&&this.store.commit("SET_QUOTA",i.quota)}async fetchRoles({accessToken:e=""}){try{const{data:{bundles:r}}=await t.axios.post("/api/v0/settings/roles-list",{},{headers:{authorization:`Bearer ${e}`,"X-Request-ID":t.v4()}});return r}catch(e){return console.error(e),[]}}async fetchSettings(){try{return await this.clientService.owncloudSdk.settings.getSettingsValues()}catch(e){return console.error(e),null}}async fetchRole({graphUser:e,accessToken:r,roles:s}){const a=(await t.axios.post("/api/v0/settings/assignments-list",{account_uuid:e.data.id},{headers:{authorization:`Bearer ${r}`,"X-Request-ID":t.v4()}})).data?.assignments.find((e=>"roleId"in e));return a?s.find((e=>e.id===a.roleId)):null}async fetchCapabilities({accessToken:e=""}){if(!t.isEmpty(this.store.getters.capabilities))return;const r=this.clientService.ocsUserContext(this.configurationManager.serverUrl,e),s=await r.getCapabilities();this.store.commit("SET_CAPABILITIES",s)}}class Q{clientService;configurationManager;store;constructor(e){this.clientService=e.clientService,this.configurationManager=e.configurationManager,this.store=e.store}static buildStorageKey(e,t){return`oc.publicLink.${e}.${t}`}async clear(e){["resolved","passwordRequired","password"].forEach((t=>{sessionStorage.removeItem(Q.buildStorageKey(e,t))})),await this.store.dispatch("runtime/auth/clearPublicLinkContext")}isResolved(e){return"true"===sessionStorage.getItem(Q.buildStorageKey(e,"resolved"))}setResolved(e,t){sessionStorage.setItem(Q.buildStorageKey(e,"resolved"),t+"")}isPasswordRequired(e){return"true"===sessionStorage.getItem(Q.buildStorageKey(e,"passwordRequired"))}setPasswordRequired(e,t){sessionStorage.setItem(Q.buildStorageKey(e,"passwordRequired"),t+"")}getPassword(e){const r=sessionStorage.getItem(Q.buildStorageKey(e,"password"));if(r)try{return t.Buffer.from(r,"base64").toString()}catch(t){this.clear(e)}return""}setPassword(e,r){if(r.length){const s=t.Buffer.from(r).toString("base64");sessionStorage.setItem(Q.buildStorageKey(e,"password"),s)}else sessionStorage.removeItem(Q.buildStorageKey(e,"password"))}async updateContext(e){if(!this.isResolved(e))return;if(this.store.getters["runtime/auth/isPublicLinkContextReady"]&&this.store.getters["runtime/auth/publicLinkToken"]===e)return;let t;this.isPasswordRequired(e)&&(t=this.getPassword(e));try{await this.fetchCapabilities({token:e,password:t})}catch(e){console.error(e)}this.store.commit("runtime/auth/SET_PUBLIC_LINK_CONTEXT",{publicLinkToken:e,publicLinkPassword:t,publicLinkContextReady:!0})}async fetchCapabilities({token:e="",password:r=""}){if(!t.isEmpty(this.store.getters.capabilities))return;const s=this.clientService.ocsPublicLinkContext(this.configurationManager.serverUrl,e,r),a=await s.getCapabilities();r?this.store.commit("SET_CAPABILITIES",{capabilities:t.omit(a.capabilities,["files.archivers"]),version:a.version}):this.store.commit("SET_CAPABILITIES",a)}}const G=new class{clientService;configurationManager;store;router;userManager;publicLinkManager;initialize(e,t,r,s){this.configurationManager=e,this.clientService=t,this.store=r,this.router=s}async initializeContext(e){if(this.publicLinkManager||(this.publicLinkManager=new Q({clientService:this.clientService,configurationManager:this.configurationManager,store:this.store})),O(this.router,e)){const t=F(e);t&&await this.publicLinkManager.updateContext(t)}this.userManager||(this.userManager=new V({clientService:this.clientService,configurationManager:this.configurationManager,store:this.store}),this.userManager.events.addAccessTokenExpired(((...e)=>{const t=()=>{console.error("AccessToken Expired：",...e),this.handleAuthError(this.router.currentRoute)};this.userManager.settings.automaticSilentRenew?this.userManager.signinSilent().catch(t):t()})),this.userManager.events.addAccessTokenExpiring(((...e)=>{console.debug("AccessToken Expiring：",...e)})),this.userManager.events.addUserLoaded((async e=>{console.debug(`New User Loaded. access_token： ${e.access_token}, refresh_token: ${e.refresh_token}`);try{await this.userManager.updateContext(e.access_token)}catch(e){console.error(e),await this.handleAuthError(this.router.currentRoute)}})),this.userManager.events.addUserUnloaded((async()=>{if(console.log("user unloaded…"),await this.resetStateAfterUserLogout(),"authError"===this.userManager.unloadReason)return this.router.push({name:"accessDenied"});if(this.configurationManager.isOAuth2){const e=this.configurationManager.oAuth2;return e.logoutUrl?window.location=e.logoutUrl:window.location=`${this.configurationManager.serverUrl}/index.php/logout`}})),this.userManager.events.addSilentRenewError((async e=>{console.error("Silent Renew Error：",e),await this.handleAuthError(this.router.currentRoute)})));const t=await this.userManager.getAccessToken();if(t)try{await this.userManager.updateContext(t)}catch(e){console.error(e),await this.handleAuthError(this.router.currentRoute)}}loginUser(e){return this.userManager.setPostLoginRedirectUrl(e),this.userManager.signinRedirect()}async signInCallback(){const e="/?"+new URLSearchParams(this.router.currentRoute.query).toString();try{await this.userManager.signinRedirectCallback(e);const t=this.userManager.getAndClearPostLoginRedirectUrl();return this.router.replace({path:t})}catch(e){return console.warn("error during authentication:",e),this.handleAuthError(this.router.currentRoute)}}async signInSilentCallback(){await this.userManager.signinSilentCallback()}async handleAuthError(e){if(O(this.router,e)){const t=F(e);return this.publicLinkManager.clear(t),this.router.push({name:"resolvePublicLink",params:{token:t},query:{redirectUrl:e.fullPath}})}q(this.router,e)&&await this.userManager.removeUser("authError")}async resolvePublicLink(e,t,r){this.publicLinkManager.setPasswordRequired(e,t),this.publicLinkManager.setPassword(e,r),this.publicLinkManager.setResolved(e,!0),await this.publicLinkManager.updateContext(e)}async logoutUser(){const e=await this.userManager.getUser();if(e&&e.id_token)return this.userManager.signoutRedirect({id_token_hint:e.id_token});await this.userManager.removeUser()}async resetStateAfterUserLogout(){await this.store.dispatch("runtime/auth/clearUserContext"),await this.store.dispatch("resetUserState"),await Promise.all([this.store.dispatch("clearDynamicNavItems"),this.store.dispatch("hideModal"),this.store.dispatch("clearSettingsValues")])}};class H extends Error{name="RuntimeError";constructor(e,...t){super([e,...t].filter(Boolean).join(", ")),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}}e.ApiError=class extends H{name="ApiError"},e.RuntimeError=H,e.authService=G,e.buildUrl=$,e.isPublicLinkContext=O,e.isUserContext=q,e.router=W}));
